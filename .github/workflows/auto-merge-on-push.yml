name: Auto merge on push

on:
  push:
    branches-ignore:
      - main
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure pull request exists
        id: ensure-pr
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ github.ref_name }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          existing_pr=$(gh pr list \
            --head "$BRANCH_NAME" \
            --state open \
            --json number \
            --jq '.[0].number')

          if [ -z "$existing_pr" ]; then
            gh pr create \
              --base "$DEFAULT_BRANCH" \
              --head "$BRANCH_NAME" \
              --title "Auto merge: $BRANCH_NAME" \
              --body "Automatically created by workflow run $GITHUB_RUN_ID after a push to $BRANCH_NAME."

            existing_pr=$(gh pr list \
              --head "$BRANCH_NAME" \
              --state open \
              --json number \
              --jq '.[0].number')
          fi

          echo "number=$existing_pr" >> "$GITHUB_OUTPUT"

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.ensure-pr.outputs.number }}
        run: |
          gh pr merge "$PR_NUMBER" --auto --squash --delete-branch
